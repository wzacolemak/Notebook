---
comments: true
---
# CVE-2022-38181

> 原文链接：[Pwning the all Google phone with a non-Google bug](https://github.blog/security/vulnerability-research/pwning-the-all-google-phone-with-a-non-google-bug/){:target="_blank"}

!!! abstrct

    Pixel 6 是第一台号称“全谷歌”的手机，但它存在一个“非谷歌”漏洞 —— Arm Mali GPU CVE-2022-38181，通过这个漏洞可以实现任意内核代码执行和获取root权限，本文将介绍这个漏洞的利用方法。

## The Arm Mali GPU

Arm Mali GPU 被广泛集成于各类设备中。安卓手机的GPU Driver是一个易于受到攻击的目标，因为它们可以直接被不可信app访问并且所有的安卓设备GPU均为 Qualcomm's Adreno 或 Arm Mali GPU，这意味着任何微小的bug都将覆盖大量设备。

事实上，2021年爆出的7个Android 0-day漏洞中有5个是针对GPU的，最近的在野利用bug为CVE-2021-39793，于2022年3月披露。包括本漏洞在内，Qualcomm Adreno 和 Arm Mali GPU 各被爆出过3个漏洞。

由于用户空间应用和GPU间内存管理的复杂性，在Arm Mali GPU的内存管理代码中有许多隐患。本漏洞涉及到GPU内存中一个特殊类型：`JIT memory`。

这里的 `JIT` 不是指编译里提到的即时编译，因为它是作为 non-excutable memory 创建的，被用作GPU kernel Driver的 memory cache，能够即时与用户程序共享。当内存不足时，它会返回给kernel使用。

许多其它类型的GPU memory都是通过 ioctl call（例如`KBASE_IOCTL_MEM_IMPORT`） 直接创建的。但 JIT memory region并非如此，它通过使用[`KBASSE_IOCTL_JOB_SUBMIT`](https://android.googlesource.com/kernel/google-modules/gpu/+/refs/heads/android-gs-raviole-5.10-android13/mali_kbase/mali_kbase_core_linux.c#822){target="_blank"} ioctl 提交一个特殊的GPU指令来创建。

`KBASE_IOCTL_JOB_SUBMIT` ioctl 可以被用来提交 "job chain" 给GPU处理。"job chain" 是包含多个job的列表，job 为不透明数据结构（opaque data structure），头部的 job header 后跟随包含特定的指令的 payload。尽管 `KBASE_IOCTL_JOB_SUBMIT` 通常用于向GPU发送指令，但也有一些job由kernel处理并运行在host CPU上。这些 software jobs(softjobs) 中包括JIT memory的allocate和free(BASE_JD_REQ_SOFT_JIT_ALLOC and BASE_JD_REQ_SOFT_JIT_FREE)。

## The life cycle of JIT memory

`KBASE_IOCTL_JOB_SUBMIT` 是一个通用的 ioctl 调用，包含许多负责处理不同类型GPU jobs的路径。`BASE_JD_REQ_SOFT_JIT_ALLOC`本质上通过调用`KBASE_JIT_allocate_process`，调用 `KBASE_ JIT_allogate_process`来创建JIT内存区域。为了说明JIT内存的生命周期和使用情况，以下介绍一些相关概念。

当使用Mali GPU驱动时，用于程序首先需要创建并初始化 `kbase_context` 内核对象。涉及用户程序打开驱动文件并使用得到的文件描述符调用一系列ioctl call。每个 file handle 都有各自的`kbase_context` 对象，负责管理打开的驱动文件的资源。它包括三个负责管理JIT memory的 [`list_head`](https://android.googlesource.com/kernel/google-modules/gpu/+/refs/heads/android-gs-raviole-5.10-android13/mali_kbase/mali_kbase_defs.h#1917){:target="_blank"} fields: the `jit_active_head`, the `jit_pool_head`, and the `jit_destroy_head`